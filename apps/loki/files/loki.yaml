auth_enabled: false

chunk_store_config:
  chunk_cache_config:
    background:
      writeback_buffer: 1000000
      writeback_goroutines: 0
      writeback_size_limit: 1MB
    default_validity: 24h
    memcached:
      batch_size: 100
      parallelism: 1
    memcached_client:
      consistent_hash: true
      max_idle_conns: 72
      timeout: 60s

common:
  # https://github.com/grafana/loki/blob/v2.9.3/pkg/loki/modules.go#L737
  # compactor_grpc_address: loki-compactor.loki.svc.cluster.local.:9095
  compactor_address: http://loki-compactor.loki.svc.cluster.local.:3100
  path_prefix: /var/loki
  replication_factor: 3
  storage:
    s3:
      access_key_id: minio
      secret_access_key: miniominio
      bucketnames: loki
      endpoint: http://minio.minio.svc.cluster.local:9000
      # endpoint: minio.minio.svc.cluster.local:9000
      insecure: true
      s3forcepathstyle: true

compactor:
  # working_directory: /var/loki/compactor
  delete_request_cancel_period: 1h
  delete_request_store: s3
  retention_delete_delay: 2h
  retention_delete_worker_count: 150
  retention_enabled: true
  # compactor_ring:
  #   kvstore:
  #     store: memberlist

distributor:
  # ring:
  #   kvstore:
  #     store: memberlist
  otlp_config:
    default_resource_attributes_as_index_labels:
      # - category
      # - cluster
      # - container
      # - daemonset
      # - deployment
      # - homelab_environment
      # - homelab_huid
      # - homelab_owner
      # - homelab_service
      # - homelab_type
      # - format
      # - k8s_cronjob_name
      # - level
      # - namespace
      # - service_name
      # - source
      # - statefulset
      - homelab_environment
      - homelab_huid
      - format
      - homelab_owner
      - homelab_service
      - homelab_type
      - "container.name"
      - "k8s.cluster.name"
      - "cluster"
      - "category"
      - "app"
      - "job"
      - "k8s.container.name"
      - "k8s.cronjob.name"
      - "k8s.daemonset.name"
      - "k8s.deployment.name"
      - "k8s.job.name"
      - "k8s.namespace.name"
      - "k8s.node.name"
      - "k8s.replicaset.name"
      - "k8s.statefulset.name"
      - "service.name"
      - "service.namespace"
      - "source"

frontend:
  encoding: protobuf
  grpc_client_config:
    # max_recv_msg_size: *max_recv_msg_size
    # max_send_msg_size: *max_send_msg_size
    grpc_compression: snappy
  # max_outstanding_per_tenant: 2000
  # compress_responses: true
  scheduler_address: loki-query-scheduler-discovery.loki.svc.cluster.local.:9095
  scheduler_worker_concurrency: 120 # default is 5, recommented to set to 120 by grafana
  tail_proxy_url: http://loki-querier.loki.svc.cluster.local.:3100

frontend_worker:
  grpc_client_config:
    # max_recv_msg_size: *max_recv_msg_size
    # max_send_msg_size: *max_send_msg_size
    grpc_compression: "snappy"
  scheduler_address: loki-query-scheduler-discovery.loki.svc.cluster.local.:9095

index_gateway:
  mode: simple
  # mode: ring
  # ring:
  #   kvstore:
  #     store: memberlist
  #   replication_factor: 1

ingester:
  chunk_encoding: snappy
  # chunk_idle_period: 30m
  # chunk_target_size: 10485760
  chunk_target_size: 20485760 # Try doubling from 10mb to 20mb to reduce minio api calls
  sync_min_utilization: 0.1 # default 0.1
  sync_period: 1h # default 1h
  # max_chunk_age: &max_chunk_age 2h
  # lifecycler:
  #   ring:
  #     kvstore:
  #       store: memberlist
  #     replication_factor: 1
  #   num_tokens: 512
  wal:
    dir: /var/loki/wal
    # enabled: false
    enabled: true
    checkpoint_duration: 5m # default 5m. checkout every 5 min to reduce recovery wal time
    flush_on_shutdown: true # flush wal on shutdown
    replay_memory_ceiling: 400MB # default 4GB max memory size the WAL may use during replay. after hitting this, it will flush data to storage before continuing.
  # chunk_idle_period: 10m # default 30m flush chunks idle for 30min
  chunk_idle_period: 30m # default 30m flush chunks idle for 30min
  # chunk_retain_period: 30s # keep in memory briefly after flush
  # max_chunk_age: 10m # default 2h force flush timeseries chunks older than 10m
  max_chunk_age: 4h # default 2h force flush timeseries chunks older than 10m
  flush_check_period: 30s # how often to check for flushable chunks
  flush_op_timeout: 10m # default 10m. timeout for flush operation
  concurrent_flushes: 16 # default 32, limit chunk flushes for lower memory usage

ingester_client:
  grpc_client_config:
    # max_recv_msg_size: &max_recv_msg_size 164000000
    # max_send_msg_size: &max_send_msg_size 164000000
    grpc_compression: snappy
  # remote_timeout: 10s

internal_server:
  http_server_idle_timeout: 10m0s
  http_server_read_timeout: 10m0s
  http_server_write_timeout: 10m0s

limits_config:
  allow_structured_metadata: true
  discover_log_levels: false # we send `level` now, so we don't need ingesters to do this work for us to created `detected_level`
  discover_service_name:
    - service_name
    - deployment
    - statefulset
    - daemonset
    - k8s_cronjob_name
  ingestion_rate_mb: 7500 # raised from 2500
  ingestion_burst_size_mb: 20 # set to maximum allowed payload in a single request, beyond this shows as "rate limited"
  max_cache_freshness_per_query: 10m
  max_concurrent_tail_requests: 200
  max_streams_per_user: 0 # unlimited (we have 100000 for global, this setting is per ingester)
  max_global_streams_per_user: 100000
  max_query_series: 5000 # default is 500
  max_line_size: 512KB  # Default is 256KB and i'd like to batch more using my logs-gateway otel collector. currently getting errors with the default 
  max_line_size_truncate: true # truncate lines rather than drop them
  per_stream_rate_limit: 15MB # default is 3
  per_stream_rate_limit_burst: 75MB # default is 15
  query_timeout: &query_timeout 300s
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  retention_period: 30d
  # split_queries_by_interval: 5m # Default is 1h.
  split_queries_by_interval: 1h # Default is 1h.
  volume_enabled: true
  shard_aggregations:
    - approx_topk
  shard_streams:
    enabled: true
    logging_enabled: false
    desired_rate: 256KB # default is 1536KB
  max_query_parallelism: 32 # default is 32 - TODO: should this just match tsdb_max_query_parallelism? need clarification from grafana
  tsdb_max_query_parallelism: 8192 # default is 128
  tsdb_sharding_strategy: bounded # default is 'power_of_two'
  volume_max_series: 5000 # default is 1000, which is too small for large tenants to load the drilldown page
  # retention_stream:
  #   - selector: '{namespace="kube-system"}'
  #     priority: 1
  #     period: 24h
  # ingestion_rate_mb: 32
  # ingestion_burst_size_mb: 64

  # max_line_size: 3MB  # Default is 256KB and i'd like to batch more using my logs-gateway otel collector. currently getting errors with the default 
  # for big logs tune
  # max_chunks_per_query: 2000000
  # max_streams_matchers_per_query: 1000
  # max_entries_limit_per_query: 5000



memberlist:
  cluster_label: loki-prod
  # TODO: maybe this will fail? should know immediately
  cluster_label_verification_disabled: false
  abort_if_cluster_join_fails: false
  join_members:
    - loki-gossip-ring.loki.svc.cluster.local.

pattern_ingester:
  enabled: true

querier:
  # query_ingesters_within: 3h  # *max_chunk_age + 1
  max_concurrent: 16
  # multi_tenant_queries_enabled: true

query_range:
  align_queries_with_step: true
  cache_results: true
  results_cache:
    cache:
      background:
        writeback_buffer: 500000
        writeback_goroutines: 1
        writeback_size_limit: 500MB
      default_validity: 12h
      memcached_client:
        # addresses: dnssrvnoa+_tcp._tcp.loki-mcrouter.loki.svc.cluster.local.
        addresses: dnssrvnoa+_memcached-client._tcp.loki-results-cache.loki.svc.cluster.local.
        timeout: 500ms
        consistent_hash: true
        update_interval: 1m
  shard_aggregations: approx_topk

query_scheduler:
  grpc_client_config:
    grpc_compression: snappy

ruler:
  # query_stats_enabled: true
  # enable_sharding: true
  # ring:
  #   kvstore:
  #     store: memberlist
  #   num_tokens: 512
  storage:
    s3:
      access_key_id: minio
      secret_access_key: miniominio
      bucketnames: loki
      endpoint: http://minio.minio.svc.cluster.local:9000
      # endpoint: minio.minio.svc.cluster.local:9000
      insecure: true
      s3forcepathstyle: true
    type: s3
  # rule_path: /var/loki
  alertmanager_url: http://alertmanager-operated.alertmanager.svc.cluster.local.:9093/alertmanager
  remote_write:
    enabled: true
    client:
      url: http://prometheus-k8s.prometheus.svc.cluster.local:9090/api/v1/write
  evaluation:
    mode: remote
    query_frontend:
      address: loki-query-frontend.loki.svc.cluster.local.:9095

schema_config:
  configs:
    - from: "2024-04-01"
      index:
        period: 24h
        prefix: loki_index_
      object_store: s3
      schema: v13
      store: tsdb

server:
  grpc_listen_port: 9095
  grpc_server_max_recv_msg_size: 157286400 # default if 4194303.
  grpc_server_max_send_msg_size: 157286400 # default if 4194303.
  grpc_server_max_concurrent_streams: 1000 # 100 is default, grafana recommends 1000
  http_listen_port: 3100
  http_server_idle_timeout: 10m0s
  http_server_read_timeout: 600s
  http_server_write_timeout: 600s
  log_format: logfmt

storage_config:
  # max_parallel_get_chunk: 150 # default 150
  # aws:
  #   s3: http://${LOKI_S3_ACCESS_KEY_ID}:${LOKI_S3_SECRET_ACCESS_KEY}@minio-api.minio.svc.cluster.local:9000/loki-app
  #   s3forcepathstyle: true
  boltdb_shipper:
    # active_index_directory: /var/loki/boltdb-shipper-index
    # cache_location: /var/loki/boltdb-shipper-cache
    # cache_ttl: 168h
    index_gateway_client:
      server_address: dns+loki-index-gateway-headless.loki.svc.cluster.local.:9095
      # grpc_client_config:
      #   max_recv_msg_size: *max_recv_msg_size
      #   max_send_msg_size: *max_send_msg_size
  hedging:
    at: 1s
    max_per_second: 20
    up_to: 3
  tsdb_shipper:
    # active_index_directory: /var/loki/tsdb-shipper-index
    # cache_location: /var/loki/tsdb-shipper-cache
    # cache_ttl: 168h
    index_gateway_client:
      server_address: dns+loki-index-gateway-headless.loki.svc.cluster.local.:9095
      # grpc_client_config:
      #   max_recv_msg_size: *max_recv_msg_size
      #   max_send_msg_size: *max_send_msg_size
  # index_queries_cache_config:
  #   redis:
  #     endpoint: loki-redis.loki.svc.cluster.local:6379
  #     expiration: 1h
tracing:
  enabled: true
  # profiling_enabled: false

analytics:
  reporting_enabled: false
