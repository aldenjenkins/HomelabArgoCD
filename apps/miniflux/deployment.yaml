apiVersion: apps/v1
kind: Deployment
metadata:
  name: miniflux
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: miniflux
      app.kubernetes.io/component: web
  template:
    metadata:
      labels:
        app.kubernetes.io/name: miniflux
        app.kubernetes.io/component: web
        sidecar.istio.io/inject: "true"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534  # nobody
        fsGroup: 65534
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-requirements
          image: curlimages/curl:8.4.0
          imagePullPolicy: IfNotPresent
          command:
            - "sh"
            - "-c"
            - |
              echo "Waiting for PostgreSQL Primary (CNPG Readyz @ HTTPS)"
              # Use curl: -f fails on HTTP errors, -k skips cert check, -s is silent
              # Using the FQDN that worked in your manual test.
              timeout 120s sh -c "while ! curl -fsk -o /dev/null https://miniflux-postgres-healthz.miniflux:8000/readyz ; do echo 'Still waiting for CNPG primary...' ; sleep 5 ; done"
              ret=$?
              echo "return : $ret"
              if [ $ret -eq 0 ] ; then
                echo "PostgreSQL Primary is Ready"
              else
                echo "FAILED : PostgreSQL Primary isn't available"
                exit 1
              fi
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      containers:
        - name: miniflux
          image: "docker.io/miniflux/miniflux:2.2.17-distroless"
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: miniflux-env
            - secretRef:
                name: miniflux-env
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  key: uri
                  name: miniflux-postgres-18-app
          ports:
            - containerPort: 8080
              name: http
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          readinessProbe:
            exec:
              command:
                - /usr/bin/miniflux
                - -healthcheck
                - auto
          resources:
            requests:
              cpu: 25m
              memory: 128Mi
            limits:
              cpu: 250m
              memory: 128Mi
              #   volumeMounts:
              #   - name: cluster-config
              #     mountPath: /etc/localtime
              #     subPath: localtime
              #     readOnly: true
              #   - name: cluster-ca-volume
              #     mountPath: /etc/ssl/cluster/ca.crt
              #     subPath: ca.crt
              # volumes:
              # - name: cluster-config
              #   configMap:
              #     name: cluster-config
              # - name: cluster-ca-volume
              #   secret:
              #     secretName: cluster-ca
