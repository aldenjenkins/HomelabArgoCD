apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
data:
  config.yml: |-
    server:
      http_listen_port: 3101
      grpc_listen_port: 0
      log_level: info

    clients:
      - url: http://loki-gateway.loki:80/loki/api/v1/push
        tenant_id: ""

    positions:
      filename: /tmp/positions.yaml

    scrape_configs:
      # Syslog receiver for RouterOS
      - job_name: syslog
        syslog:
          listen_address: 0.0.0.0:1514
          listen_protocol: udp
          idle_timeout: 60s
          label_structured_data: yes
          syslog_format: rfc3164
          use_rfc5424_message: false
          labels:
            job: "syslog"
        relabel_configs:
          # Extract facility and severity
          - source_labels: [__syslog_message_severity]
            target_label: severity
          - source_labels: [__syslog_message_facility]
            target_label: facility
          # Extract hostname from syslog
          - source_labels: [__syslog_message_hostname]
            target_label: routerboard
          # Set device type for RouterOS
          - target_label: device_type
            replacement: routeros
          # Extract connection IP as device identifier
          - source_labels: [__syslog_connection_ip_address]
            target_label: syslog_host_ip
          - source_labels: [__syslog_connection_hostname]
            target_label: syslog_host
