apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: kube-prometheus
    app.kubernetes.io/part-of: kube-prometheus
    prometheus: k8s
    role: alert-rules
  name: mailinabox-prometheus-rules
spec:
  groups:
    - name: mailinabox-backup
      rules:
        # Alert if backup fails
        - alert: MailInABoxBackupFailed
          expr: mailinabox_backup_success == 0
          for: 5m
          labels:
            severity: critical
            service: mailinabox-backup
          annotations:
            summary: "Mail-in-a-Box backup failed"
            description: "Mail-in-a-Box backup has failed on {{ $labels.instance }}. Last successful backup was {{ $value }}."
        # Alert if backup is too old
        - alert: MailInABoxBackupTooOld
          expr: mailinabox_backup_age_hours > 26
          for: 15m
          labels:
            severity: warning
            service: mailinabox-backup
          annotations:
            summary: "Mail-in-a-Box backup is too old"
            description: "Mail-in-a-Box backup is {{ $value }} hours old, which exceeds the 26-hour threshold."
        # Alert if backup size is suspiciously small
        - alert: MailInABoxBackupSizeSmall
          expr: mailinabox_backup_size_bytes < 1000000  # Less than 1MB
          for: 5m
          labels:
            severity: warning
            service: mailinabox-backup
          annotations:
            summary: "Mail-in-a-Box backup size is suspiciously small"
            description: "Mail-in-a-Box backup size is only {{ $value | humanize1024 }}B, which may indicate an incomplete backup."
        # Alert if no backup metrics (node exporter down or script issues)
        - alert: MailInABoxBackupMetricsMissing
          expr: absent(mailinabox_backup_success)
          for: 30m
          labels:
            severity: warning
            service: mailinabox-backup
          annotations:
            summary: "Mail-in-a-Box backup metrics missing"
            description: "Mail-in-a-Box backup metrics are missing from {{ $labels.instance }}. This may indicate node exporter or backup script issues."
